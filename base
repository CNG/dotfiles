#!/bin/bash

# mostly from https://gist.github.com/binaerbaum/535884a7f5b8a8697557 but automated the partitioning
# loadkeys dvorak

set -o xtrace
set -o errexit

# ROOTDEVICE=$(lsblk -d -p -n -l -o NAME -e 7,11 | head -1)
ROOTDEVICE=/dev/nvme0n1
HOSTNAME=Charlie24
SETUPDIR=/tmp/setup
WIFI_SSID=NinePinesGuqin

iwctl station wlan0 connect $WIFI_SSID

timedatectl set-ntp true

# In case we are rerunning and need to clean up...
swapoff -a
umount ${ROOTDEVICE}* /mnt | true
umount $ROOTDEVICE"p1" /mnt/boot | true

# Create partitions
parted --script $ROOTDEVICE mklabel gpt
partprobe
# EFI
sgdisk --new=0:0:+512M --typecode=1:ef00 $ROOTDEVICE
sgdisk --change-name=1:EFI $ROOTDEVICE
mkfs.vfat -F32 $ROOTDEVICE"p1"
# Windows
sgdisk --new=0:0:+100G $ROOTDEVICE
# Encrypted root, swap
sgdisk --new=0:0:0 $ROOTDEVICE
cryptsetup --batch-mode luksFormat --type luks2 $ROOTDEVICE"p3" # enter password
cryptsetup luksAddKey $ROOTDEVICE"p3" # enter password AS IF US KEYBOARD
cryptsetup open --type luks $ROOTDEVICE"p3" luks
pvcreate /dev/mapper/luks
vgcreate linux /dev/mapper/luks
swapsize=$(cat /proc/meminfo | grep MemTotal | awk '{ print $2 }')
swapsize=$(($swapsize/1000))"M"
lvcreate --size $swapsize linux --name swap
lvcreate -l +100%FREE linux --name root
mkfs.ext4 /dev/mapper/linux-root
mkswap /dev/mapper/linux-swap

# Mount the new system 
mount /dev/mapper/linux-root /mnt # /mnt is the installed system
swapon /dev/mapper/linux-swap # Not needed but a good thing to test
mkdir -p /mnt/boot
mount $ROOTDEVICE"p1" /mnt/boot

sed -i '/Parallel/c\ParallelDownloads = 50' /etc/pacman.conf
# Install the system also includes stuff needed for starting wifi when first booting into the newly installed system
# Unless vim and zsh are desired these can be removed from the command. Dialog is needed by wifi-menu
# terminus-font allows selecting larger font for small HiDPI screens
# pacstrap /mnt base base-devel zsh vim git sudo efibootmgr dialog wpa_supplicant networkmanager
pacman -Sy archlinux-keyring
pacstrap /mnt base linux linux-firmware lvm2 base-devel efibootmgr networkmanager terminus-font

# 'install' fstab
genfstab -pU /mnt >> /mnt/etc/fstab
# Make /tmp a ramdisk
echo "tmpfs	/tmp	tmpfs	defaults,noatime,mode=1777	0	0" >> /mnt/etc/fstab
# Change relatime on all non-boot partitions to noatime (reduces wear if using an SSD)

# Enter the new system
cp -a $SETUPDIR/dotfiles/base_include /mnt
arch-chroot /mnt ./base_include ${ROOTDEVICE}p2 $HOSTNAME

# Unmount all partitions
umount -R /mnt
swapoff -a

# Reboot into the new system, don't forget to remove the cd/usb
reboot
