---
- name: Install VirtualBox and dependencies
  pacman: name={{ item }} state=present
  with_items:
    - net-tools
    - qt4
    - virtualbox-guest-iso
    - virtualbox
    - virtualbox-host-dkms

- name: Install VirtualBox extensions
  aur: name=virtualbox-ext-oracle user={{ user.name }}
  tags:
    - aur

- name: Push VirtualBox kernel module build script
  copy: src=build_vbox_modules.sh dest=/root/build_vbox_modules.sh mode=0700
  tags:
    - grsec

- name: Build VirtualBox kernel modules
  command: /root/build_vbox_modules.sh
  tags:
    - grsec

- name: Copy kernel modules to load
  copy: src=modules.conf dest=/etc/modules-load.d/virtualbox.conf

- name: Add the user to vboxusers group
  user: name={{ user.name }} groups=vboxusers append=yes
